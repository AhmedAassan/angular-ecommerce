<div class="checkout-container">
  <!-- Header -->
  <div class="checkout-header">
    <h1>Checkout</h1>
    <p>Complete your order in a few simple steps</p>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading checkout options...</p>
    </div>
  } @else {
    <!-- Stepper -->
    <mat-stepper 
      #stepper 
      [linear]="true" 
      [orientation]="'vertical'"
      (selectionChange)="onStepChange($event)"
      class="checkout-stepper">
      
      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <!-- STEP 1: ORDER TYPE -->
      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <mat-step [stepControl]="orderTypeForm" label="Order Type">
        <ng-template matStepLabel>
          <span class="step-label">
            <mat-icon>local_shipping</mat-icon>
            <span>Order Type</span>
            @if (selectedOrderType()) {
              <span class="step-selected">- {{ selectedOrderType()?.englishName }}</span>
            }
          </span>
        </ng-template>

        <div class="step-content">
          <h3>How would you like to receive your order?</h3>
          
          <div class="order-type-grid">
            @for (orderType of orderTypes(); track trackByOrderType($index, orderType)) {
              <div 
                class="order-type-card"
                [class.selected]="isOrderTypeSelected(orderType)"
                (click)="selectOrderType(orderType)"
                tabindex="0"
                (keydown.enter)="selectOrderType(orderType)"
                (keydown.space)="selectOrderType(orderType); $event.preventDefault()">
                
                <div class="card-icon">
                  <mat-icon>{{ getOrderTypeIcon(orderType) }}</mat-icon>
                </div>
                
                <div class="card-content">
                  <h4>{{ orderType.englishName }}</h4>
                  <p class="arabic-name">{{ orderType.arabicName }}</p>
                </div>

                <div class="card-check" [class.visible]="isOrderTypeSelected(orderType)">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
            }
          </div>

          <div class="step-actions">
            <button 
              mat-flat-button 
              color="primary" 
              matStepperNext
              [disabled]="!orderTypeForm.valid">
              Continue
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <!-- STEP 2: DELIVERY ADDRESS (Conditional) -->
      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <mat-step 
        [stepControl]="addressSelectionForm" 
        [optional]="!isDelivery()"
        label="Delivery Address">
        <ng-template matStepLabel>
          <span class="step-label">
            <mat-icon>location_on</mat-icon>
            <span>{{ isDelivery() ? 'Delivery Address' : 'Address (Not Required)' }}</span>
            @if (isDelivery() && selectedAddress()) {
              <span class="step-selected">- {{ getAreaLabel(selectedAddress()!.areaId) }}</span>
            }
          </span>
        </ng-template>

        <div class="step-content">
          @if (isDelivery()) {
            <!-- Delivery Address Selection -->
            <h3>Select or add a delivery address</h3>

            @if (loadingAddresses()) {
              <div class="loading-inline">
                <mat-spinner diameter="30"></mat-spinner>
                <span>Loading your addresses...</span>
              </div>
            } @else {
              <!-- Existing Addresses -->
              @if (addresses().length > 0) {
                <div class="address-list">
                  @for (address of addresses(); track trackByAddress($index, address)) {
                    <div 
                      class="address-card"
                      [class.selected]="isAddressSelected(address)"
                      (click)="selectAddress(address.id)"
                      tabindex="0"
                      (keydown.enter)="selectAddress(address.id)"
                      (keydown.space)="selectAddress(address.id); $event.preventDefault()">
                      
                      <div class="address-icon">
                        <mat-icon>home</mat-icon>
                      </div>
                      
                      <div class="address-details">
                        <h4>{{ getAreaLabel(address.areaId) }}</h4>
                        <p>
                          Block {{ address.blockNumber }}, Street {{ address.street }}
                          <br>
                          Building {{ address.buildingNumber }}
                          @if (address.floorNumber) {
                            , Floor {{ address.floorNumber }}
                          }
                          @if (address.flatNumber) {
                            , Flat {{ address.flatNumber }}
                          }
                        </p>
                        <p class="delivery-charge">
                          <mat-icon>local_shipping</mat-icon>
                          Delivery charge:
                          {{ address.deliveryCharge | number: '1.3-3' }}
                          <strong>KWD</strong>
                        </p>
                        @if (address.note) {
                          <p class="address-note">
                            <mat-icon>note</mat-icon>
                            {{ address.note }}
                          </p>
                        }
                      </div>

                      <div class="address-check" [class.visible]="isAddressSelected(address)">
                        <mat-icon>check_circle</mat-icon>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-addresses">
                  <mat-icon>location_off</mat-icon>
                  <p>No saved addresses found</p>
                  <p class="hint">Add a new address below</p>
                </div>
              }

              <!-- Add New Address Button -->
              <div class="add-address-section">
                <button 
                  mat-stroked-button 
                  color="primary" 
                  (click)="toggleAddressForm()"
                  class="add-address-btn">
                  <mat-icon>{{ showAddressForm() ? 'close' : 'add_location' }}</mat-icon>
                  {{ showAddressForm() ? 'Cancel' : 'Add New Address' }}
                </button>
              </div>

              <!-- New Address Form -->
              @if (showAddressForm()) {
                <div class="new-address-form" [@fadeInOut]>
                  <h4>Add New Address</h4>
                  
                  <form [formGroup]="newAddressForm" (ngSubmit)="saveNewAddress()">
                    <div class="form-grid">
                      <!-- Area Selection -->
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Area</mat-label>
                        <mat-select formControlName="areaId" required>
                          <mat-option [value]="0" disabled>Select Area</mat-option>
                          @for (area of areas(); track area.id) {
                            <mat-option [value]="area.id">
                              {{ area.englishName }} — {{ area.arabicName }}
                            </mat-option>
                          }
                        </mat-select>
                        @if (newAddressForm.get('areaId')?.hasError('min') && newAddressForm.get('areaId')?.touched) {
                          <mat-error>Please select an area</mat-error>
                        }
                      </mat-form-field>

                      <!-- Block Number -->
                      <mat-form-field appearance="outline">
                        <mat-label>Block Number</mat-label>
                        <input matInput formControlName="blockNumber" required>
                        @if (newAddressForm.get('blockNumber')?.hasError('required') && newAddressForm.get('blockNumber')?.touched) {
                          <mat-error>Block number is required</mat-error>
                        }
                      </mat-form-field>

                      <!-- Street -->
                      <mat-form-field appearance="outline">
                        <mat-label>Street</mat-label>
                        <input matInput formControlName="street" required>
                        @if (newAddressForm.get('street')?.hasError('required') && newAddressForm.get('street')?.touched) {
                          <mat-error>Street is required</mat-error>
                        }
                      </mat-form-field>

                      <!-- Avenue -->
                      <mat-form-field appearance="outline">
                        <mat-label>Avenue (Optional)</mat-label>
                        <input matInput formControlName="avenue">
                      </mat-form-field>

                      <!-- Building Number -->
                      <mat-form-field appearance="outline">
                        <mat-label>Building Number</mat-label>
                        <input matInput formControlName="buildingNumber" required>
                        @if (newAddressForm.get('buildingNumber')?.hasError('required') && newAddressForm.get('buildingNumber')?.touched) {
                          <mat-error>Building number is required</mat-error>
                        }
                      </mat-form-field>

                      <!-- Floor Number -->
                      <mat-form-field appearance="outline">
                        <mat-label>Floor Number (Optional)</mat-label>
                        <input matInput formControlName="floorNumber">
                      </mat-form-field>

                      <!-- Flat Number -->
                      <mat-form-field appearance="outline">
                        <mat-label>Flat Number (Optional)</mat-label>
                        <input matInput formControlName="flatNumber">
                      </mat-form-field>

                      <!-- Address Link -->
                      <mat-form-field appearance="outline">
                        <mat-label>Google Maps Link (Optional)</mat-label>
                        <input matInput formControlName="addressLink" placeholder="https://maps.google.com/...">
                        <mat-icon matSuffix>link</mat-icon>
                      </mat-form-field>

                      <!-- Note -->
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Delivery Instructions (Optional)</mat-label>
                        <textarea matInput formControlName="note" rows="2"></textarea>
                      </mat-form-field>
                    </div>

                    <div class="form-actions">
                      <button 
                        mat-flat-button 
                        color="primary" 
                        type="submit"
                        [disabled]="newAddressForm.invalid || savingAddress()">
                        @if (savingAddress()) {
                          <mat-spinner diameter="20"></mat-spinner>
                        } @else {
                            <ng-container>
                          <mat-icon>save</mat-icon>
                          Save Address
                          </ng-container>
                        }
                      </button>
                    </div>
                  </form>
                </div>
              }
            }
          } @else {
            <!-- Pickup - No Address Needed -->
            <div class="pickup-info">
              <mat-icon>store</mat-icon>
              <h3>Pickup Order</h3>
              <p>No delivery address required. You will pick up your order from our store.</p>
            </div>
          }

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button 
              mat-flat-button 
              color="primary" 
              matStepperNext
              [disabled]="isDelivery() && !selectedAddressId()">
              Continue
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <!-- STEP 3: PAYMENT METHOD -->
      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <mat-step [stepControl]="paymentForm" label="Payment Method">
        <ng-template matStepLabel>
          <span class="step-label">
            <mat-icon>payment</mat-icon>
            <span>Payment Method</span>
          </span>
        </ng-template>

        <div class="step-content">
          <h3>How would you like to pay?</h3>

          <div class="payment-grid">
            @for (method of paymentMethods; track trackByPayment($index, method)) {
              <div 
                class="payment-card"
                [class.selected]="isPaymentMethodSelected(method)"
                (click)="selectPaymentMethod(method)"
                tabindex="0"
                (keydown.enter)="selectPaymentMethod(method)"
                (keydown.space)="selectPaymentMethod(method); $event.preventDefault()">
                
                <div class="card-icon">
                  <mat-icon>{{ getPaymentIcon(method) }}</mat-icon>
                </div>
                
                <div class="card-content">
                  <h4>{{ method.nameEN }}</h4>
                  <p class="arabic-name">{{ method.nameAR }}</p>
                  @if (method.id === 1) {
                    <p class="payment-note">Payment link will be sent via WhatsApp</p>
                  }
                </div>

                <div class="card-check" [class.visible]="isPaymentMethodSelected(method)">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
            }
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button 
              mat-flat-button 
              color="primary" 
              matStepperNext>
              Review Order
              <mat-icon>arrow_forward</mat-icon>
            </button>
          </div>
        </div>
      </mat-step>

      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <!-- STEP 4: ORDER REVIEW & CONFIRMATION -->
      <!-- ═══════════════════════════════════════════════════════════════════ -->
      <mat-step label="Review & Confirm">
        <ng-template matStepLabel>
          <span class="step-label">
            <mat-icon>fact_check</mat-icon>
            <span>Review & Confirm</span>
          </span>
        </ng-template>

        <div class="step-content">
          <h3>Review Your Order</h3>

          <div class="order-summary">
                        <!-- Order Type Summary -->
            <div class="summary-section">
              <div class="summary-header">
                <mat-icon>local_shipping</mat-icon>
                <span>Order Type</span>
                <button mat-icon-button (click)="stepper.selectedIndex = 0" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
              </div>
              <div class="summary-content">
                <mat-chip-set>
                  <!-- FIX: Guard against null using @if with alias -->
                  @if (selectedOrderType(); as type) {
                    <mat-chip [highlighted]="true" color="primary">
                      <mat-icon matChipAvatar>{{ getOrderTypeIcon(type) }}</mat-icon>
                      {{ type.englishName }}
                    </mat-chip>
                  } @else {
                    <!-- Fallback to prevent crash if nothing is selected -->
                    <mat-chip color="warn" [highlighted]="true">
                      <mat-icon matChipAvatar>warning</mat-icon>
                      Select Order Type
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </div>


            <mat-divider></mat-divider>

            <!-- Address Summary (Delivery Only) -->
            @if (isDelivery()) {
              <div class="summary-section">
                <div class="summary-header">
                  <mat-icon>location_on</mat-icon>
                  <span>Delivery Address</span>
                  <button mat-icon-button (click)="stepper.selectedIndex = 1" matTooltip="Edit">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
                <div class="summary-content">
                  @if (selectedAddress(); as address) {
                    <div class="address-summary">
                      <p class="area">{{ getAreaLabel(address.areaId) }}</p>
                      <p>
                        Block {{ address.blockNumber }}, Street {{ address.street }}
                        <br>
                        Building {{ address.buildingNumber }}
                        @if (address.floorNumber) {
                          , Floor {{ address.floorNumber }}
                        }
                        @if (address.flatNumber) {
                          , Flat {{ address.flatNumber }}
                        }
                      </p>
                      <p class="delivery-charge">
                        <mat-icon>local_shipping</mat-icon>
                        Delivery charge:
                        {{ address.deliveryCharge | number: '1.3-3' }}
                        <strong>KWD</strong>
                      </p>
                      @if (address.note) {
                        <p class="note">
                          <mat-icon>note</mat-icon>
                          {{ address.note }}
                        </p>
                      }
                    </div>
                  } @else {
                    <p class="error">No address selected</p>
                  }
                </div>
              </div>
              <mat-divider></mat-divider>
            }

            <!-- Payment Method Summary -->
            <div class="summary-section">
              <div class="summary-header">
                <mat-icon>payment</mat-icon>
                <span>Payment Method</span>
                <button mat-icon-button (click)="stepper.selectedIndex = 2" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
              </div>
              <div class="summary-content">
                @for (method of paymentMethods; track method.id) {
                  @if (isPaymentMethodSelected(method)) {
                    <mat-chip-set>
                      <mat-chip [highlighted]="true" color="accent">
                        <mat-icon matChipAvatar>{{ getPaymentIcon(method) }}</mat-icon>
                        {{ method.nameEN }}
                      </mat-chip>
                    </mat-chip-set>
                    @if (method.id === 1) {
                      <p class="payment-info">
                        <mat-icon>info</mat-icon>
                        Payment link will be sent to your WhatsApp
                      </p>
                    }
                  }
                }
              </div>
            </div>
          </div>

          <div class="step-actions final">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button 
              mat-flat-button 
              color="primary"
              class="submit-btn"
              (click)="submitCheckout()"
              [disabled]="submitting()">
              @if (submitting()) {
                <mat-spinner diameter="20"></mat-spinner>
                Processing...
              } @else {
                <ng-container>
                <mat-icon>check_circle</mat-icon>
                Place Order
                </ng-container>
              }
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  }
</div>