<!-- src/app/pages/cart/cart.html -->

<!-- =============== PAGE MODE =============== -->
<div *ngIf="pageMode; else drawerTpl" class="cart cart--page">
  
  <!-- Header -->
  <div class="cart__top">
    <h1 class="cart__title">
      <span>{{ isGuest ? 'Shopping as Guest' : 'Your Cart' }}</span>
      <small *ngIf="items.length" class="cart__count">
        ({{ items.length }} item{{ items.length > 1 ? 's' : '' }})
      </small>
      <!-- Guest Badge in Title -->
      <span *ngIf="isGuest && items.length" class="cart__guest-badge">
        <svg viewBox="0 0 24 24" class="icon icon--sm">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Guest
      </span>
    </h1>

    <button type="button" class="btn-icon cart__refresh" 
            (click)="refresh()" 
            [class.is-loading]="loading"
            aria-label="Refresh cart">
      <svg viewBox="0 0 24 24" class="icon">
        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" />
        <path d="M21 3v5h-5" />
        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" />
        <path d="M3 21v-5h5" />
      </svg>
    </button>
  </div>

  <!-- Syncing Indicator -->
  <div *ngIf="syncing" class="sync-notice anim-fade-in">
    <div class="spinner spinner--sm"></div>
    <span>Syncing your cart to your account...</span>
  </div>

  <!-- Loading State -->
  <section *ngIf="loading" class="loading anim-fade-in" aria-live="polite">
    <div class="loader">
      <span></span><span></span><span></span>
    </div>
    <p>Loading your cart...</p>
  </section>

  <!-- Empty State -->
  <section *ngIf="!loading && !items.length" class="empty anim-fade-in" aria-live="polite">
    <div class="empty__art">
      <svg viewBox="0 0 24 24" class="icon icon--xl">
        <circle cx="8" cy="21" r="1"></circle>
        <circle cx="19" cy="21" r="1"></circle>
        <path d="m2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
      </svg>
      <div class="empty__dots"><i></i><i></i><i></i></div>
    </div>
    <h3>Your cart awaits</h3>
    <p>Discover amazing products and start your shopping journey</p>
    <button routerLink="/" type="button" class="btn btn--pill btn--primary">Start Shopping</button>
  </section>

  <!-- Cart Content -->
  <section *ngIf="!loading && items.length" class="grid">
    <div class="grid__col">
      
      <!-- Guest Login Banner (Minimal, matches cart design) -->
      <div *ngIf="isGuest" class="guest-banner anim-fade-in">
        <div class="guest-banner__icon">
          <svg viewBox="0 0 24 24" class="icon">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 16v-4M12 8h.01"></path>
          </svg>
        </div>
        <div class="guest-banner__content">
          <span class="guest-banner__text">
            Your cart is saved locally on this device.
          </span>
          <a routerLink="/login" class="guest-banner__link">
            <svg viewBox="0 0 24 24" class="icon icon--sm">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
              <polyline points="10 17 15 12 10 7"/>
              <line x1="15" y1="12" x2="3" y2="12"/>
            </svg>
            Sign in to sync & checkout
          </a>
        </div>
      </div>

      <!-- Cart Items -->
      <article class="item anim-item" 
               *ngFor="let item of items; trackBy: trackById; let i = index"
               [style.animationDelay.ms]="i * 70">
        
        <!-- Local/Guest Badge -->
        <span *ngIf="item.isLocal" class="item__badge item__badge--local" title="Saved on this device">
          <svg viewBox="0 0 24 24" class="icon icon--xs">
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
            <line x1="8" y1="21" x2="16" y2="21"></line>
            <line x1="12" y1="17" x2="12" y2="21"></line>
          </svg>
        </span>

        <div class="item__media">
          <img [src]="item.imageUrl" 
               [alt]="item.name" 
               (error)="onImgError($event)"
               loading="lazy" />
        </div>

        <div class="item__main">
          <h4 class="item__name">{{ item.name }}</h4>

          <div class="item__meta" *ngIf="item.unitName || item.variant">
            <span class="tag" *ngIf="item.unitName">{{ item.unitName }}</span>
            <span class="tag tag--muted" *ngIf="item.variant">{{ item.variant }}</span>
          </div>

          <div class="item__price">
            <span class="item__unit">{{ item.price | number:'1.3-3' }} KWD</span>
            <span class="item__unit-note">per unit</span>
          </div>
        </div>

        <div class="item__actions">
          <div class="qty">
            <span class="qty__label">Qty</span>
            <div class="qty__box">
              <button type="button" class="qty__btn" 
                      (click)="changeQty(item, item.qty - 1)" 
                      [disabled]="item.qty <= 1"
                      aria-label="Decrease quantity">
                <svg viewBox="0 0 24 24" class="icon">
                  <path d="M5 12h14" />
                </svg>
              </button>

              <output class="qty__val" aria-live="polite">{{ item.qty }}</output>

              <button type="button" class="qty__btn" 
                      (click)="changeQty(item, item.qty + 1)"
                      aria-label="Increase quantity">
                <svg viewBox="0 0 24 24" class="icon">
                  <path d="M12 5v14M5 12h14" />
                </svg>
              </button>
            </div>
          </div>

          <div class="item__total">
            <span class="item__total-label">Total</span>
            <span class="item__total-amt">{{ item.lineTotal | number:'1.3-3' }} KWD</span>
          </div>

          <button type="button" class="btn-icon btn-icon--danger" 
                  (click)="remove(item)" 
                  aria-label="Remove item">
            <svg viewBox="0 0 24 24" class="icon">
              <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
            </svg>
          </button>
        </div>
      </article>
    </div>

    <!-- Order Summary Sidebar -->
    <aside class="summary anim-slide-up">
      <h3 class="summary__title">Order Summary</h3>

      <!-- Guest Mode Indicator in Summary -->
      <div *ngIf="isGuest" class="summary__guest-info">
        <svg viewBox="0 0 24 24" class="icon icon--sm">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <span>Shopping as Guest</span>
      </div>

      <div class="summary__row">
        <span>Subtotal ({{ items.length }} item{{ items.length > 1 ? 's' : '' }})</span>
        <span class="amt">{{ subTotal | number:'1.3-3' }} KWD</span>
      </div>

      <div class="summary__row summary__row--total">
        <span>Total</span>
        <span class="amt amt--total">{{ subTotal | number:'1.3-3' }} KWD</span>
      </div>

      <div class="summary__actions">
        <button type="button" 
                class="btn btn--pill btn--primary btn--lg"
                (click)="proceedToCheckout()">
          <svg *ngIf="isGuest" viewBox="0 0 24 24" class="icon icon--sm">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
            <polyline points="10 17 15 12 10 7"/>
            <line x1="15" y1="12" x2="3" y2="12"/>
          </svg>
          <span>{{ isGuest ? 'Sign in to Checkout' : 'Proceed to Checkout' }}</span>
          <svg *ngIf="!isGuest" viewBox="0 0 24 24" class="icon">
            <path d="M9 18l6-6-6-6" />
          </svg>
        </button>

        <button type="button" class="btn btn--pill btn--ghost-danger" (click)="clearAll()">
          <svg viewBox="0 0 24 24" class="icon">
            <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
          </svg>
          Clear Cart
        </button>
      </div>

      <!-- Guest Hint -->
      <p *ngIf="isGuest" class="summary__hint">
        <svg viewBox="0 0 24 24" class="icon icon--xs">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 16v-4M12 8h.01"></path>
        </svg>
        Sign in to save your cart across devices
      </p>
    </aside>
  </section>
</div>

<!-- =============== DRAWER MODE =============== -->
<ng-template #drawerTpl>
  <div class="drawer__overlay" *ngIf="isOpen" (click)="close()"></div>

  <aside class="drawer" [class.drawer--open]="isOpen" role="dialog" aria-label="Shopping cart">
    <header class="drawer__head">
      <div class="drawer__title">
        <h3>{{ isGuest ? 'Guest Cart' : 'Shopping Cart' }}</h3>
        <span *ngIf="items.length" class="badge">{{ items.length }}</span>
      </div>
      <button type="button" class="btn-icon" (click)="close()" aria-label="Close cart">
        <svg viewBox="0 0 24 24" class="icon">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </header>

    <!-- Syncing Notice -->
    <div *ngIf="syncing" class="drawer__sync">
      <div class="spinner spinner--sm"></div>
      <span>Syncing cart...</span>
    </div>

    <!-- Guest Banner in Drawer -->
    <div *ngIf="isGuest && items.length && !syncing" class="drawer__guest-banner">
      <span>Cart saved locally</span>
      <a routerLink="/login" (click)="close()">Sign in</a>
    </div>

    <section class="drawer__body" *ngIf="!loading; else drawerLoading">
      <div *ngIf="!items.length" class="drawer__empty">
        <svg viewBox="0 0 24 24" class="icon">
          <circle cx="8" cy="21" r="1"></circle>
          <circle cx="19" cy="21" r="1"></circle>
          <path d="m2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
        </svg>
        <p>Your cart is empty</p>
        <button type="button" class="btn btn--pill btn--primary" (click)="close()">
          Continue Shopping
        </button>
      </div>

      <div *ngIf="items.length" class="drawer__list">
        <article class="mini" *ngFor="let item of items; trackBy: trackById">
          <div class="mini__media">
            <img [src]="item.imageUrl" 
                 [alt]="item.name" 
                 (error)="onImgError($event)"
                 loading="lazy" />
            <!-- Local Badge on Image -->
            <span *ngIf="item.isLocal" class="mini__local-badge" title="Saved locally">
              <svg viewBox="0 0 24 24" class="icon icon--xs">
                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                <line x1="8" y1="21" x2="16" y2="21"></line>
                <line x1="12" y1="17" x2="12" y2="21"></line>
              </svg>
            </span>
          </div>

          <div class="mini__main">
            <h5 class="mini__name">{{ item.name }}</h5>
            <div class="mini__meta" *ngIf="item.unitName || item.variant">
              <span *ngIf="item.unitName">{{ item.unitName }}</span>
              <span *ngIf="item.variant && item.unitName"> · </span>
              <span *ngIf="item.variant">{{ item.variant }}</span>
            </div>

            <div class="mini__foot">
              <div class="mini__price">{{ item.price | number:'1.3-3' }} KWD</div>
              <div class="mini__qty">
                <button type="button" 
                        (click)="changeQty(item, item.qty - 1)" 
                        [disabled]="item.qty <= 1">−</button>
                <span>{{ item.qty }}</span>
                <button type="button" (click)="changeQty(item, item.qty + 1)">+</button>
              </div>
            </div>
          </div>

          <div class="mini__total">{{ item.lineTotal | number:'1.3-3' }} KWD</div>

          <button type="button" class="btn-icon btn-icon--sm" (click)="remove(item)" aria-label="Remove item">
            <svg viewBox="0 0 24 24" class="icon">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </article>
      </div>
    </section>

    <ng-template #drawerLoading>
      <div class="drawer__loading">
        <div class="spinner"></div>
      </div>
    </ng-template>

    <footer class="drawer__foot" *ngIf="items.length">
      <div class="drawer__line">
        <span>Total</span>
        <strong class="drawer__total">{{ subTotal | number:'1.3-3' }} KWD</strong>
      </div>

      <button type="button" 
              class="btn btn--pill btn--primary btn--lg"
              (click)="proceedToCheckout()">
        <span>{{ isGuest ? 'Sign in to Checkout' : 'Checkout' }}</span>
        <svg viewBox="0 0 24 24" class="icon">
          <path d="M9 18l6-6-6-6" />
        </svg>
      </button>
    </footer>
  </aside>
</ng-template>