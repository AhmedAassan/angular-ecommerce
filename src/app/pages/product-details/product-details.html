<!-- src/app/pages/product-details/product-details.html -->

<ng-template #loading>
  <div class="text-center py-5">
    <div class="spinner-border"></div>
    <p class="mt-3 text-muted">Loading product...</p>
  </div>
</ng-template>

<ng-container *ngIf="product$ | async as product; else loading">

  <div class="split-wrap container my-4">
    
    <!-- Guest Cart Banner -->
    <div *ngIf="(isLoggedIn$ | async) === false && (cartManager.itemCount$ | async) as cartCount" 
         class="guest-cart-banner mb-4">
      <div class="banner-content">
        <div class="banner-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
        </div>
        <div class="banner-text">
          <strong>Shopping as Guest</strong>
          <span>You have {{ cartCount }} item{{ cartCount > 1 ? 's' : '' }} in your cart. 
            <a routerLink="/login" class="banner-link">Sign in</a> to save your cart and checkout.
          </span>
        </div>
        <a routerLink="/cart" class="banner-action btn btn-sm btn-outline-primary">
          View Cart
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </a>
      </div>
    </div>

    <div class="row g-4 align-items-stretch">

      <!-- HERO -->
      <div class="col-12 col-md-5">
        <div class="hero position-relative">
          <img [src]="product.fullImageUrl" 
               [alt]="product.englishName || product.arabicName || 'Product image'"
               class="w-100 h-100" 
               onerror="this.src='assets/images/placeholder.jpg'">

          <button class="wishlist-btn" 
                  [class.active]="product.isWished" 
                  (click)="toggleWishlist(product, $event)">
            <i class="bi" [ngClass]="product.isWished ? 'bi-heart-fill' : 'bi-heart'"></i>
          </button>

          <!-- Sale Badge -->
          <div class="sale-badge" *ngIf="product.discountPercentage">
            <span>-{{ product.discountPercentage }}%</span>
          </div>
        </div>
      </div>

      <!-- SHEET -->
      <div class="col-12 col-md-7">
        <div class="sheet" [class.is-adding]="isAddingToCart">

          <!-- title + unit subtitle -->
          <h5 class="fw-bold">{{ product.englishName || product.arabicName }}</h5>

          <!-- price (dynamic) -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="price-wrap">
              <span class="h5 m-0 price-color">{{ calcPrice(product) }} KWD</span>
              <span class="original-price ms-2" *ngIf="product.originalPrice && product.originalPrice > calcPrice(product)">
                {{ product.originalPrice | number:'1.3-3' }} KWD
              </span>
            </div>
          </div>

          <!-- Units Selection -->
          <div class="option-group mb-3" *ngIf="product.units?.length">
            <label class="option-label">
              <i class="bi bi-box option-icon"></i>
              Unit
            </label>
            <div class="option-grid">
              <label *ngFor="let u of product.units" 
                     class="option-card unit-option"
                     [class.selected]="u.itemUnitId === selectedUnitId">
                <input type="radio" 
                       name="unit" 
                       [value]="u.itemUnitId"
                       [checked]="u.itemUnitId === selectedUnitId" 
                       (change)="selectUnit(u.itemUnitId)">
                <div class="option-content">
                  <span class="option-name">{{ u.displayName }}</span>
                  <span class="option-price">{{ u.price }} KWD</span>
                </div>
                <i class="bi bi-check-circle-fill option-check"></i>
              </label>
            </div>
          </div>

          <!-- MODIFIERS (multi select) -->
          <div class="mb-3" *ngIf="product.modifiers?.length">
            <label class="option-label">
              <i class="bi bi-plus-circle option-icon"></i>
              Add-ons
            </label>
            <div class="modifiers-simple">
              <label *ngFor="let m of product.modifiers" 
                     class="modifier-simple"
                     [class.selected]="selectedModifiers.has(m.modifierId)">
                <input type="checkbox" 
                       [checked]="selectedModifiers.has(m.modifierId)"
                       (change)="toggleModifier(m.modifierId)">
                <span class="modifier-text">{{ m.displayName }}</span>
                <span class="modifier-badge">+{{ m.price }} KWD</span>
              </label>
            </div>
          </div>

          <!-- VARIANTS: Color then Size -->
          <div class="mb-3" *ngIf="getColors(product).length">
            <label class="option-label mb-1">
              <i class="bi bi-palette option-icon"></i>
              Color
            </label>
            <div class="d-flex flex-wrap gap-2">
              <button *ngFor="let c of getColors(product)" 
                      class="color-chip"
                      [ngStyle]="{ background: c.toLowerCase() }" 
                      [class.selected]="c === selectedColor"
                      (click)="setColor(c, product)">
                <i class="bi bi-check color-check"></i>
              </button>
            </div>
          </div>

          <div class="mb-3" *ngIf="getSizes(product).length">
            <label class="option-label mb-1">
              <i class="bi bi-arrows-expand option-icon"></i>
              Size
            </label>
            <div class="d-flex flex-wrap gap-2">
              <button *ngFor="let s of getSizes(product)" 
                      class="size-chip btn btn-outline-secondary btn-sm"
                      [class.active]="s === selectedSize" 
                      (click)="setSize(s)">
                {{ s }}
              </button>
            </div>
          </div>

          <!-- quantity -->
          <div class="qty-box mb-4">
            <button class="qty-btn minus" (click)="dec()" [disabled]="qty <= 1">&#8722;</button>
            <span class="qty-value">{{ qty | number:'2.0' }}</span>
            <button class="qty-btn plus" (click)="inc()">&#43;</button>
          </div>

          <!-- CTAs -->
          <button *ngIf="product.itemType !== 2" class="btn btn-add w-100 mb-2 mt-3" 
                  (click)="addToCart(product)"
                  [disabled]="isAddingToCart"
                  [class.loading]="isAddingToCart"
                  [class.success]="justAdded">
            <ng-container *ngIf="!isAddingToCart && !justAdded">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
              </svg>
              <span>Add to Cart</span>
            </ng-container>
            <ng-container *ngIf="isAddingToCart">
              <span class="loading-spinner me-2"></span>
              <span>Adding...</span>
            </ng-container>
            <ng-container *ngIf="justAdded && !isAddingToCart">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              <span>Added!</span>
            </ng-container>
          </button>

          <button *ngIf="product.itemType !== 2" class="btn btn-buy w-100" 
                  (click)="buyNow(product)"
                  [disabled]="isAddingToCart">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
              <line x1="7" y1="7" x2="7.01" y2="7"></line>
            </svg>
            <span>Buy Now</span>
          </button>
          <!-- Book Now - only for booking products (itemType === 2) -->
          <button *ngIf="product.itemType === 2" 
              class="btn btn-book w-100 mb-2 mt-3"
              (click)="bookNow(product)"
              [disabled]="isBooking"
              [class.loading]="isBooking"
              [class.success]="justBooked">
            <!-- Success State -->
              <ng-container *ngIf="justBooked">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span>Booked!</span>
              </ng-container>
              <!-- Loading State -->
              <ng-container *ngIf="isBooking && !justBooked">
                <span class="loading-spinner"></span>
                <span>Booking...</span>
              </ng-container>
              <!-- Default State -->
              <ng-container *ngIf="!isBooking && !justBooked">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Booking Now</span>
              </ng-container>
          </button>
          <!-- Guest indicator -->
          <div class="guest-add-indicator" *ngIf="justAdded && (isLoggedIn$ | async) === false">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>Saved locally - Sign in to sync</span>
          </div>

        </div>
      </div>
    </div>

    <!-- You May Also Like -->
    <div class="row g-4 align-items-stretch py-5" *ngIf="(related$ | async) as relatedProducts">
      <h4 class="mt-4 mb-2 fw-semibold text-center may-like" *ngIf="relatedProducts.length > 0">
        You May Also Like
      </h4>
      <div class="col-md-12 mb-3" *ngIf="relatedProducts.length > 0">
        <div class="suggest-list">
          <div *ngFor="let item of relatedProducts" 
               class="suggest-card-wrap">
            <a [routerLink]="['/product', (item.itemId ?? item.id)]"
               class="suggest-card"
               [class.is-adding]="item.isAddingToCart">
              <img [src]="item.fullImageUrl || item.fullImageUrl"
                   [alt]="item.englishName || item.arabicName || 'Related item'"
                   onerror="this.src='assets/images/placeholder.jpg'">
              
              <!-- Quick add to cart button for related products -->
              <button *ngIf="product.itemType !== 2" class="suggest-add-btn" 
                      (click)="addRelatedToCart(item, $event)"
                      [disabled]="item.isAddingToCart"
                      [class.loading]="item.isAddingToCart"
                      [class.success]="item.justAdded">
                <ng-container *ngIf="!item.isAddingToCart && !item.justAdded">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                  </svg>
                </ng-container>
                <ng-container *ngIf="item.isAddingToCart">
                  <span class="mini-spinner"></span>
                </ng-container>
                <ng-container *ngIf="item.justAdded && !item.isAddingToCart">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </ng-container>
              </button>
              <button *ngIf="item.itemType === 2" 
                  class="suggest-add-btn" 
                  (click)="bookNow(item, $event)"
                  [disabled]="item.isBooking"
                  [class.loading]="item.isBooking"
                  [class.success]="item.justBooked">
                 <!-- Default State - Calendar Icon -->
                <ng-container *ngIf="!item.isBooking && !item.justBooked">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                </ng-container>
                <!-- Loading State -->
                <ng-container *ngIf="item.isBooking">
                  <span class="mini-spinner"></span>
                </ng-container>
                <!-- Success State -->
                <ng-container *ngIf="item.justBooked && !item.isBooking">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </ng-container>
             </button>
            </a>
            <div class="suggest-info">
              <p class="suggest-name">{{ item.englishName || item.arabicName }}</p>
              <p class="suggest-price">{{ item.price | number:'1.3-3' }} KWD</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- Floating Cart Button (Mobile) -->
<div class="floating-cart d-lg-none" *ngIf="cartManager.itemCount$ | async as cartCount">
  <button class="floating-cart-btn" routerLink="/cart" [class.has-items]="cartCount > 0">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="9" cy="21" r="1"></circle>
      <circle cx="20" cy="21" r="1"></circle>
      <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
    <span class="cart-badge" *ngIf="cartCount > 0">{{ cartCount > 99 ? '99+' : cartCount }}</span>
  </button>
</div>

<!-- Cart Toast -->
<div class="cart-toast" [class.show]="showCartToast">
  <div class="toast-content">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    <span>Added to cart</span>
  </div>
  <a routerLink="/cart" class="toast-action">View Cart</a>
</div>